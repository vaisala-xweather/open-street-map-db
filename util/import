#!/bin/bash
set -euo pipefail

DIR="$(dirname "$(readlink -f "$0")")"
cd $DIR/../

# Parse arguments
SKIP_IMPORT_EXTRA=false
SKIP_OSM_DOWNLOAD=false
SKIP_OSM_IMPORTER=false
SKIP_IMPORT_GEN=false

for arg in "$@"; do
  case $arg in
    --help|-h)
      echo "Usage: $0 [OPTIONS]"
      echo ""
      echo "Import OpenStreetMap data and related datasets into PostgreSQL/PostGIS."
      echo ""
      echo "Options:"
      echo "  --skip-import-extra    Skip importing extra datasets (oceans, continents, coastlines, wind, solar, transmission lines)"
      echo "  --skip-osm-download    Skip downloading the OSM planet file from S3"
      echo "  --skip-osm-importer    Skip the main OSM import step"
      echo "  --skip-import-gen      Skip the import-gen step"
      echo "  --help, -h             Show this help message"
      exit 0
      ;;
    --skip-import-extra)
      SKIP_IMPORT_EXTRA=true
      shift
      ;;
    --skip-osm-download)
      SKIP_OSM_DOWNLOAD=true
      shift
      ;;
    --skip-osm-importer)
      SKIP_OSM_IMPORTER=true
      shift
      ;;
    --skip-import-gen)
      SKIP_IMPORT_GEN=true
      shift
      ;;
    *)
      echo "Unknown option: $arg"
      echo "Usage: $0 [--skip-import-extra] [--skip-osm-download] [--skip-osm-importer] [--skip-import-gen]"
      echo "Use --help for more information."
      exit 1
      ;;
  esac
done

docker compose up --wait -d db

# These are all the extra data sets that can be useful outside of basic OSM data
if [ "$SKIP_IMPORT_EXTRA" = false ]; then
  docker compose run --remove-orphans import-extra osm-oceans
  docker compose run import-extra osm-continents
  docker compose run import-extra osm-coastlines
  docker compose run import-extra usgs-wind-us
  docker compose run import-extra usgs-solar-us
  docker compose run import-extra us-hifld-transmission-lines
fi

# Copy the full OSM data set from S3
if [ "$SKIP_OSM_DOWNLOAD" = false ]; then
  # Import the latest planet file
  aws s3 cp --no-sign-request s3://osm-pds/planet-latest.osm.pbf ./data/downloads/world.osm.pbf
fi

# Skip if --skip-osm-importer was passed
if [ "$SKIP_OSM_IMPORTER" = false ]; then
  docker compose up --remove-orphans import
fi

# Skip if --skip-import-gen was passed
if [ "$SKIP_IMPORT_GEN" = false ]; then
  docker compose up import-gen
fi

# This is some specific derived stuff

sudo docker exec osm-postgis-db psql -U maps-user -d maps -c "
-- Drop the view if it exists
DROP MATERIALIZED VIEW IF EXISTS public.osm_power_generators_enriched CASCADE;

-- Create materialized view with USGS enrichment
CREATE MATERIALIZED VIEW public.osm_power_generators_enriched AS
SELECT
    osm.id,
    osm.node_id,
    osm.name,
    osm.energy_source,
    osm.generator_type,
    osm.operator,
    osm.geom,
    -- Enriched fields from USGS data (for wind) or OSM data
    COALESCE(usgs.project_name, osm.name) as project_name,
    COALESCE(usgs.year_online::text, osm.start_date) as year_online,
    COALESCE(usgs.hub_height_m, osm.wind_hub_height_m) as hub_height_m,
    COALESCE(usgs.rotor_diameter_m, osm.wind_rotor_diameter_m) as rotor_diameter_m,
    COALESCE(usgs.total_height_m, osm.wind_total_height_m) as total_height_m,
    COALESCE(usgs.manufacturer, osm.manufacturer) as manufacturer,
    COALESCE(usgs.model, osm.model) as model,
    COALESCE(usgs.capacity_mw, osm.capacity_mw) as capacity_mw
FROM public.osm_power_generators osm
LEFT JOIN LATERAL (
    SELECT
        project_name,
        year_online,
        hub_height_m,
        rotor_diameter_m,
        total_height_m,
        manufacturer,
        model,
        capacity_mw
    FROM public.usgs_power_wind_generators usgs
    WHERE ST_DWithin(osm.geom, usgs.geom, 100)
    ORDER BY ST_Distance(osm.geom, usgs.geom)
    LIMIT 1
) usgs ON osm.energy_source = 'wind';

-- Create indexes for performance
CREATE INDEX osm_power_generators_enriched_geom_idx ON public.osm_power_generators_enriched USING gist(geom);
CREATE INDEX osm_power_generators_enriched_energy_source_idx ON public.osm_power_generators_enriched (energy_source);
CREATE INDEX osm_power_generators_enriched_project_name_idx ON public.osm_power_generators_enriched (project_name);
CREATE INDEX osm_power_generators_enriched_id_idx ON public.osm_power_generators_enriched (id);

ANALYZE public.osm_power_generators_enriched;
"
